/**
 ** kvm.js - 一款兼容AMD,CMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.2.2
 **/
!function(){kvm.module.registerPlugin(function(e){e.registerPathMaper(function(){var e=kvm.module.data("alias");kvm.isAbsolutePath(this.id)||e[this.id]&&(this.uri=e[this.id],this._parser())})})}(),function(){kvm.module.registerPlugin(function(e){e.registerModuleParser(function(){function t(e){var t,i;for(t=0;t<e.length;t++)for(i=t+1;i<e.length;i++)e[t].equal(e[i])&&e.splice(i,1);return e}function i(e){var t=!1;return e.forEach(function(e){return"require"==e.id?(t=!0,!1):void 0}),t}this.injectCommonjs=function(){var t=this;this.injectors.exports=function(){return t.module.exports=t.module.exports||{},t.module.exports},this.injectors.module=function(){return t.module},this.injectors.require=function(){return function(t){var i=e.createPath(t),r=i.getModule();return r&&r.module&&r.module.exports?r.module.exports:{}}}},this.collectDeps=function(){var i;kvm.isFunction(this.factory)&&(i=this.parseDependencies(this.factory.toString()),i=i.map(function(t){return e.createPath(t)}),this.depPaths=t(this.depPaths.concat(i)))},this.parseDependencies=function(e){function t(){d=e.charAt(f++)}function i(){return/\s/.test(d)}function r(){return'"'==d||"'"==d}function n(){var i=f,r=d,n=e.indexOf(r,i);if(-1==n)f=l;else if("\\"!=e.charAt(n-1))f=n+1;else for(;l>f;)if(t(),"\\"==d)f++;else if(d==r)break;m&&(g.push(e.slice(i,f-1)),m=0)}function s(){for(f--;l>f;)if(t(),"\\"==d)f++;else{if("/"==d)break;if("["==d)for(;l>f;)if(t(),"\\"==d)f++;else if("]"==d)break}}function o(){return/[a-z_$]/i.test(d)}function u(){var t=e.slice(f-1),i=/^[\w$]+/.exec(t)[0];v={"if":1,"for":1,"while":1,"with":1}[i],h={"break":1,"case":1,"continue":1,"debugger":1,"delete":1,"do":1,"else":1,"false":1,"if":1,"in":1,"instanceof":1,"return":1,"typeof":1,"void":1}[i],m=/^require\s*\(\s*(['"]).+?\1\s*\)/.test(t),m?(i=/^require\s*\(\s*['"]/.exec(t)[0],f+=i.length-2):f+=/^[\w$]+(?:\s*\.\s*[\w$]+)*/.exec(t)[0].length-1}function a(){return/\d/.test(d)||"."==d&&/\d/.test(e.charAt(f))}function c(){var t,i=e.slice(f-1);t="."==d?/^\.\d+(?:E[+-]?\d*)?\s*/i.exec(i)[0]:/^0x[\da-f]*/i.test(i)?/^0x[\da-f]*\s*/i.exec(i)[0]:/^\d+\.?\d*(?:E[+-]?\d*)?\s*/i.exec(i)[0],f+=t.length-1,h=0}if(-1==e.indexOf("require"))return[];for(var d,f=0,l=e.length,h=1,m=0,v=0,p=[],g=[];l>f;)t(),i()||(r()?(n(),h=1):"/"==d?(t(),"/"==d?(f=e.indexOf("\n",f),-1==f&&(f=e.length)):"*"==d?(f=e.indexOf("*/",f),-1==f?f=l:f+=2):h?(s(),h=0):(f--,h=1)):o()?u():a()?c():"("==d?(p.push(v),h=1):")"==d?h=p.pop():(h="]"!=d,m=0));return g},this.injectCommonjs(),this.factory&&i(this.depPaths)&&this.collectDeps()})})}(),function(){kvm.module.registerPlugin(function(e){e.registerDriverLoader("css",function(e,t){var i=document,r=i.head||i.getElementsByTagName("head")[0]||i.documentElement,n=window.document.createElement("link"),s=window.document.styleSheets,o=this;n.rel="stylesheet",n.href=e,n.media="only x",t&&(n.onload=function(){t&&t(null,n)},n.onerror=function(){t&&t(!0)}),r.appendChild(n),n.onloadcssdefined=function(t){for(var i,r=0;r<s.length;r++)s[r].href&&s[r].href.indexOf(e)>-1&&(i=!0);i?t():setTimeout(function(){n.onloadcssdefined(t)})},n.onloadcssdefined(function(){n.media=o.path.query&&o.path.query.media||"all"})}),e.registerDriverLoaded(function(e,t){var i=this.path;"css"!=i.ext||e||kvm.module.define(i.id,function(){return t})})})}(),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data();e.registerPathParser(function(){var e,i,r=t.baseUrl,n=t.packages,s=this.uri||this.id;s&&(i=s.indexOf("/"),e=s.substr(0,i),n&&n[e]&&(this.baseUrl=n[e].uri||n[e].url||r,this.uri=s.substr(i+1),this._parseVars()))})})}(),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data();e.registerPathMaper(function(){var e=t.shims[this.id];e&&(this.uri=e.uri||e.url,this._parser())}),e.registerDriverBeforeLoad(function(){var i=this.path,r=t.shims[i.id];r&&r.exports&&!r.factory&&window[r.exports]&&(this.module=e.createModule(i.id,function(){return window[r.exports]}))}),e.registerDriverLoaded(function(){var e=this.path,i=t.shims[e.id];i&&!e.getModule()&&(kvm.isFunction(i.factory)||kvm.isArray(i.factory)?kvm.module.define(e.id,i.factory):kvm.module.define(e.id,function(){return window[i.exports]}))})})}();